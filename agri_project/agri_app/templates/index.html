{% extends 'base_generic.html' %}
{% load static %}
{% block title %}Smart Agriculture: Data-Driven Farming{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">

    <div class="text-center mb-16">
        <h1 class="text-5xl font-extrabold text-gray-900 mb-4">
            Welcome to <span class="text-green-600">Smart KiVu Agriculture</span>
        </h1>
        <p class="text-xl text-gray-600 max-w-3xl mx-auto">
            Leveraging technology to bring efficiency, sustainability, and data-driven insights to farming.
        </p>
        <p class="mt-4 text-lg text-green-700 font-medium">
            Our mission is to empower farmers with tools like planting calendars, weather tracking, and field management systems to maximize yield and minimize resource use.
        </p>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-16">
        
        <div class="p-6 bg-white rounded-lg shadow-lg border-t-4 border-green-500">
            <i class="fas fa-chart-line text-3xl text-green-600 mb-3"></i>
            <h3 class="text-2xl font-semibold mb-2">Data-Driven Decisions</h3>
            <p class="text-gray-600">Access real-time data on soil health, crop growth, and environmental factors to make informed choices.</p>
        </div>

        <div class="p-6 bg-white rounded-lg shadow-lg border-t-4 border-green-500">
            <i class="fas fa-calendar-alt text-3xl text-green-600 mb-3"></i>
            <h3 class="text-2xl font-semibold mb-2">Optimized Planting</h3>
            <p class="text-gray-600">Utilize our custom planting calendar based on local climate and crop needs for optimal timing.</p>
        </div>

        <div class="p-6 bg-white rounded-lg shadow-lg border-t-4 border-green-500">
            <i class="fas fa-cloud-sun-rain text-3xl text-green-600 mb-3"></i>
            <h3 class="text-2xl font-semibold mb-2">Precision Forecasting</h3>
            <p class="text-gray-600">Get accurate weather updates to plan irrigation and harvest schedules effectively.</p>
        </div>

    </div>

    <div class="max-w-4xl mx-auto px-4 mt-10">
        <h2 class="text-2xl font-bold mb-6">What Our Users Say</h2>
        <div class="space-y-4">
            {% for review in reviews %}
                <div class="p-4 border-l-4 border-green-500 bg-gray-50">
                    <p class="italic text-gray-700">"{{ review.content }}"</p>
                    <p class="text-sm font-bold mt-2">— {{ review.author_name }}</p>
                </div>
            {% endfor %}
            <div class="mt-6 text-center">
            <a href="{% url 'all_reviews' %}" class="text-green-600 font-bold hover:underline">
                See More Reviews &rarr;
            </a>
    </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-6">
        <a href="{% url 'post_create' %}" class="block w-full">
            <div class="w-full bg-white border border-gray-300 rounded-lg py-3 px-5 text-gray-500 hover:border-blue-400 hover:bg-gray-50 transition duration-200 shadow-sm cursor-pointer">
                Add a post
            </div>
        </a>
    

        <div class="bg-white p-6 rounded-lg shadow-sm border mt-10">

            <h3 class="text-xl font-bold mb-6">Discussion</h3>
            {% if post %}
            <form action="{% url 'add_comment' post.pk %}" method="POST" class="mb-8">
                {% csrf_token %}
                <textarea name="content" placeholder="Add a comment..." class="w-full border rounded-lg p-3 focus:ring-2 focus:ring-blue-500 outline-none"></textarea>
                <button type="submit" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700">Post Comment</button>
            </form>
            {% else %}
                <p class="text-gray-500 italic">There are no posts available to discuss yet.</p>
            {% endif %}
            <div class="space-y-8">
                {% for comment in post.comments.all %}
                    {% if not comment.parent %} <div class="flex gap-3 group">
                            <div class="flex-shrink-0 w-10 h-10 bg-gray-200 rounded shadow-sm overflow-hidden">
                                <img src="https://ui-avatars.com/api/?name={{ comment.author.username }}" alt="avatar">
                            </div>
                            
                            <div class="flex-grow">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-blue-700 hover:underline cursor-pointer">{{ comment.author.username }}</span>
                                    <span class="text-xs text-gray-400">{{ comment.created_at|timesince }} ago</span>
                                </div>
                                <p class="text-gray-800 text-sm leading-relaxed">{{ comment.content }}</p>
                                
                                <div class="flex items-center gap-4 mt-2 text-xs font-semibold text-gray-500">
                                    <button class="flex items-center gap-1 bg-gray-100 px-2 py-1 rounded hover:bg-gray-200">
                                        ▲ {{ comment.total_likes }}
                                    </button>
                                    <button onclick="showReplyForm('{{ comment.id }}')" class="hover:text-blue-600">Reply</button>
                                    <button class="text-gray-300">•••</button>
                                </div>

                                <div class="mt-4 ml-6 space-y-4 border-l-2 border-gray-100 pl-4">
                                    {% for reply in comment.replies.all %}
                                        <div class="flex gap-3">
                                            <div class="w-8 h-8 bg-gray-100 rounded-full overflow-hidden">
                                                <img src="https://ui-avatars.com/api/?name={{ reply.author.username }}" alt="avatar">
                                            </div>
                                            <div>
                                                <div class="flex items-center gap-2">
                                                    <span class="font-bold text-sm text-blue-700">{{ reply.author.username }}</span>
                                                    <span class="text-xs text-gray-400">{{ reply.created_at|timesince }} ago</span>
                                                </div>
                                                <p class="text-gray-700 text-sm">{{ reply.content }}</p>
                                            </div>
                                        </div>
                                    {% endfor %}
                                    
                                    <div id="reply-form-container-{{ comment.id }}" class="hidden mt-4">
                                        <form action="{% url 'add_comment' post.id %}" method="POST">
                                            {% csrf_token %}
                                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                                            <textarea name="content" class="w-full border p-2 text-sm rounded" placeholder="Reply to {{ comment.author.username }}..."></textarea>
                                            <div class="flex gap-2 mt-2">
                                                <button type="submit" class="bg-blue-600 text-white px-3 py-1 text-xs rounded">Reply</button>
                                                <button type="button" onclick="hideReplyForm('{{ comment.id }}')" class="text-gray-500 text-xs">Cancel</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>

</div>
{% for message in messages %}
    {% if message.tags == 'info' and message.message == 'show_review_modal' %}
    <div id="reviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 transition-opacity duration-300">
        <div class="bg-white rounded-lg p-8 max-w-lg w-full shadow-2xl">
            <h3 class="text-xl font-bold mb-2">How are you doing?</h3>
            <p class="text-gray-600 mb-6 text-sm">You haven't posted a review this month. We'd love to hear your feedback!</p>
            
            <form action="{% url 'submit_review' %}" method="POST" class="space-y-4">
                {% csrf_token %}
                <textarea name="content" placeholder="Write your monthly review..." 
                          class="w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-1 focus:ring-green-500"></textarea>
                
                <div class="flex justify-end gap-3">
                    <button type="button" onclick="closeModal()" class="text-gray-400 hover:text-gray-600 font-medium">Dismiss</button>
                    <button type="submit" class="bg-green-600 text-white px-6 py-2 rounded font-bold hover:bg-green-700">Submit</button>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
{% endfor %}
<script src="{% static 'js/notifications.js' %}"></script>
{% endblock content %}